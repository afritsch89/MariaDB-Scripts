#!/bin/bash

# Set the path to the redo log files
log_path="/var/lib/mysql"

# Connect to the MariaDB server and execute the FLUSH ENGINE LOGS command
mysql -e "FLUSH ENGINE LOGS;"

# Get the size of the redo log files in bytes
log_size=$(($(stat -c%s "$log_path/ib_logfile0") + $(stat -c%s "$log_path/ib_logfile1")))

# Loop until the log is fully flushed
while true; do

    # Execute the SHOW ENGINE INNODB STATUS command and extract the "Log flushed up to" value
    log_flushed_up_to=$(mysql -e "SHOW ENGINE INNODB STATUS\G" | grep "Log flushed up to" | awk '{print $NF}')

    # Calculate the percentage of the redo log that has been flushed
    percent_completed=$(( log_flushed_up_to * 100 / log_size ))

    # Calculate the LSN to completion
    lsn_to_completion=$(( log_size - log_flushed_up_to ))

    # Display the current LSN, LSN to completion, and percentage completed
    printf "Current LSN: %d\nLSN to completion: %d\nPercentage completed: %d%%\n" "$log_flushed_up_to" "$lsn_to_completion" "$percent_completed"

    # Check if the log has been fully flushed
    if [[ "$log_flushed_up_to" == *"purged"* ]]; then
        # If the log has been purged, exit the loop
        break
    fi

    # Sleep for 1 second before checking the status again
    sleep 1
done

# Display a message indicating that the log has been fully flushed
echo "Log has been fully flushed."
